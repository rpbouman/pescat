<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="Type=text/html; charset=utf-8" />
    <title>Pescat</title>
    <link rel="stylesheet" type="text/css" href="../css/pescat.css"/>
    <script type="text/javascript">
      var CONTEXT_PATH = parent.CONTEXT_PATH;
      var active_theme = parent.active_theme;
      var core_theme_tree = parent.core_theme_tree;
      var module_theme_tree = parent.module_theme_tree;
    </script>
    <script type="text/javascript" src="/pentaho/js/themeResources.js"></script>
  </head>
  <body>
    <div id="toolbar" class="toolbar mainToolbar">
      <label class="label">Paper size</label>
      <select id="paperSize" onchange="applySettings()">
      </select>
      <label class="label">Page Orientation</label>
      <input type="radio" name="orientation" id="portrait" onclick="applySettings()" checked="true"/><label class="radio">Portrait</label>
      <input type="radio" name="orientation" id="landscape" onclick="applySettings()"/><label class="radio">Landscape</label>
      <button class="pentaho-button" onclick="doPrint()">Print</button>
      <button class="pentaho-button" onclick="toClipboard()">Clipboard</button>
    </div>
    <div id="screenshot-container">
      <img id="screenshot" />
    </div>
    <div id="ruler"></div>
    <script type="text/javascript">
      var pescatInstance = window.parent.pescatInstance;
      //sizes in pixels
      var imageWidth = pescatInstance.imageWidth;
      var imageHeight = pescatInstance.imageHeight;
      //sizes in millimeter
      var rulerWidth = "100";
      var margins = "20";
      var paperSizes = {
        "A4": [210, 297],
        "A3": [297, 420],
        "Legal": [215.9, 355.6],
        "Letter": [215.9, 279.4]
      };

      window.onload = function(){
        pescatInstance.renderScreenshot();
      };

      window.doPrint = function(){
        var toolbar = document.getElementById("toolbar");
        var style = toolbar.style;
        style.display = "none";
        window.print();
        style.display = "";
      };

      window.getPaperSizeSelect = function() {
        return document.getElementById("paperSize");
      };

      window.getRuler = function() {
        return document.getElementById("ruler");
      };

      window.getScreenshot = function(){
        return document.getElementById("screenshot");
      }

     window.getPaperSize = function() {
        var paperSizeSelect = window.getPaperSizeSelect();
        var index = paperSizeSelect.selectedIndex;
        var option = paperSizeSelect.options[index];
        paperSize = option.value;
        return paperSizes[paperSize];
      };

      window.getOrientation = function() {
        var portrait = document.getElementById("portrait");
        var landscape = document.getElementById("landscape");
        if (portrait.checked) {
          return "portrait";
        }
        else
        if (landscape.checked) {
          return "landscape";
        }
        else {
          throw "No selection";
        }
      };

      window.applySettings = function() {
        var ruler = getRuler();
        var paperSize = getPaperSize();
        var orientation = getOrientation();
        var h, w;
        if (orientation === "portrait") {
          w = paperSize[0];
          h = paperSize[1];
        }
        else
        if (orientation === "landscape") {
          w = paperSize[1];
          h = paperSize[0];
        }
        var iw = imageWidth / ruler.clientWidth * rulerWidth;
        var ih = imageHeight / ruler.clientWidth * rulerWidth;
        if (iw > w || ih > h) {
          var screenshot = getScreenshot();
          var wFactor = w / iw;
          var hFactor = h / ih;
          var factor;
          if (wFactor > hFactor) {
            factor = hFactor;
          }
          else {
            factor = wFactor;
          }
          screenshot.height = factor * imageHeight;
          screenshot.width = factor * imageWidth;
        }
      };

      window.renderScreenshot = function(data, width, height) {
        var screenshot = getScreenshot();
        screenshot.src = "data:image/png;base64,"  + data;
        imageWidth = width;
        imageHeight = height;
      };

      window.init = function() {
        var paperSize, option
            paperSizeSelect = getPaperSizeSelect(),
            ruler = getRuler();
        ;
        for (paperSize in paperSizes) {
          option = document.createElement("OPTION");
          option.innerHTML = paperSize;
          option.value = paperSize;
          option.label = paperSize;
          paperSizeSelect.appendChild(option);
        }
        applySettings();
      };

      init();
    </script>
  </body>
</html>
